{% extends "base.html" %}
{% load static %}

<!-- {% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/score_cards.css' %}">
    <link rel="stylesheet" href="{% static 'css/score_rows.css' %}">
{% endblock %} -->



{% block content %}

<!-- <input type="hidden" id="global-csrf" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> -->

<div class="dashboard-tabs">
    <a href="?tab=inbox" class="tab-link {% if current_tab == 'inbox' %}active{% endif %}">Inbox</a>
    <a href="?tab=shortlisted" class="tab-link {% if current_tab == 'shortlisted' %}active{% endif %}">Shortlisted</a>
    <a href="?tab=interviews" class="tab-link {% if current_tab == 'interviews' %}active{% endif %}">Interviews</a>
    <a href="?tab=rejected" class="tab-link {% if current_tab == 'rejected' %}active{% endif %}">Rejected</a>
    <a href="?tab=hired" class="tab-link {% if current_tab == 'hired' %}active{% endif %}">Hired</a>
</div>

<div class="filters-bar">
    <div class="dashboard-header">
        <h2>Dashboard</h2>
        <p class="muted">
            {% if current_tab == 'inbox' %}Active Applications
            {% elif current_tab == 'shortlisted' %}Shortlisted Candidates
            {% elif current_tab == 'interviews' %}Scheduled Interviews
            {% elif current_tab == 'rejected' %}Rejected Candidates
            {% else %}Hired Candidates{% endif %}
        </p>
    </div>

    <form method="get" id="dashboard-filter-form">
        <input type="hidden" name="tab" value="{{ current_tab }}">

        <div class="filter-group">
            <span class="label-text">Filter by JD</span>
            <select name="job">
                <option value="">All active</option>
                {% for job in jobs %}
                    <option value="{{ job.id }}" {% if selected_job and job.id == selected_job.id %}selected{% endif %}>
                        {{ job.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <span class="label-text">Sort</span>
            <select name="sort">
                <option value="score_date" {% if sort == "score_date" %}selected{% endif %}>Score then Date</option>
                <option value="date_score" {% if sort == "date_score" %}selected{% endif %}>Date then Score</option>
                <option value="score_desc" {% if sort == "score_desc" %}selected{% endif %}>AI Score (high→low)</option>
                <option value="score_asc" {% if sort == "score_asc" %}selected{% endif %}>AI Score (low→high)</option>
                <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Newest first</option>
                <option value="date_asc" {% if sort == "date_asc" %}selected{% endif %}>Oldest first</option>
                <option value="human_desc" {% if sort == "human_desc" %}selected{% endif %}>Human Priority (high→low)</option>
                <option value="human_asc" {% if sort == "human_asc" %}selected{% endif %}>Human Priority (low→high)</option>
            </select>
        </div>

        <div class="filter-group">
            <span class="label-text">View</span>
            <select name="view">
                <option value="tiles" {% if view_mode == "tiles" %}selected{% endif %}>Tiles</option>
                <option value="table" {% if view_mode == "table" %}selected{% endif %}>Table</option>
            </select>
        </div>

        <div class="filter-group search-group">
            <span class="label-text">Message search</span>
            <input type="text" id="chat-inline" placeholder="Free-form search (optional)">
        </div>

        <input type="hidden" id="chat-session-id" value="{{ chat_session.session_key }}">
        <input type="hidden" name="apply" value="1">
        
        <div class="btn-div">
             <div class="filter-group">
                <span class="label-text">Favorites</span>
                <label class="switch">
                    <input type="checkbox" name="favorites" value="1" {% if request.GET.favorites %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider round"></span>
                </label>
            </div>   
            <div class="button-group">
                <button type="submit" class="btn-primary">Apply</button>
                <a role="button" class="btn-primary" href="{% url 'export_scores_csv' %}?job={{ request.GET.job }}&sort={{ request.GET.sort }}">Download CSV</a>
            </div>
        </div>
    </form>
</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

{% if not show_results %}
    <div class="state-message">
        <p class="muted">Click <strong>Apply</strong> to load results.</p>
    </div>
{% elif total_count == 0 %}
    <div class="state-message">
        <p>No candidates found in <strong>{{ current_tab|title }}</strong>.</p>
    </div>
{% else %}
    <div class="results-meta">
        <span class="muted" id="result-count">
            Showing {{ page_obj.end_index }} of {{ total_count }} result{% if total_count != 1 %}s{% endif %}
        </span>
    </div>

    <div id="results-wrapper"
         data-total="{{ total_count }}"
         data-loaded="{{ page_obj.end_index }}"
         data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% endif %}"
         data-view-mode="{{ view_mode }}"
         data-sort="{{ sort }}"
         data-job-id="{% if selected_job %}{{ selected_job.id }}{% endif %}"
         data-page-size="{{ page_size }}"
         data-current-tab="{{ current_tab }}">
        
        {% if view_mode == "table" %}
        <div class="table-responsive">
            <table class="score-table">
                <thead>
                    <tr>
                        <th>Job</th>
                        <th>Resume</th>
                        <th>Candidate</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th>Received</th>
                        <th>Total Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="score-table-body">
                    {% include "jobs/partials/score_rows.html" %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="grid-cards" id="score-card-grid">
            {% include "jobs/partials/score_cards.html" %}
        </div>
        {% endif %}
    </div>

    <div id="scroll-status" class="muted" {% if not page_obj.has_next %}style="display:none;"{% endif %}>
        {% if page_obj.has_next %}
            <div class="loading-spinner"></div> Scroll to load more results...
        {% else %}
            All results loaded.
        {% endif %}
    </div>
{% endif %}

<dialog id="humanRateModal" style="border:none; border-radius:12px; padding:0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 450px; max-width:90vw;">
    <div class="modal-header" style="background:#f8fafc; padding:15px 20px; border-bottom:1px solid #e2e8f0;">
        <h3 style="margin:0; font-size:1.1rem; color:#1e293b;">Manager Rating</h3>
        <p id="rateModalSub" style="margin:5px 0 0; font-size:0.85rem; color:#64748b;">Rate Candidate</p>
    </div>
    
    <form id="humanRateForm" method="post" style="padding: 20px; max-height: 70vh; overflow-y: auto; opacity: 1; background-color: #ffffff;">
        <div id="criteriaInputs"></div>

        <div class="modal-actions" style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" class="btn-cancel" onclick="document.getElementById('humanRateModal').close()" 
                    style="padding:8px 16px; border:1px solid #cbd5e1; background:white; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
            <button type="submit" class="btn-submit" 
                    style="padding:8px 16px; border:none; background:#2563eb; color:white; border-radius:6px; cursor:pointer;">
                Save Score
            </button>
        </div>
    </form>
</dialog>

<!-- <dialog id="scheduleModal" style="border:none; border-radius:12px; padding:0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 450px; max-width:90vw;">
    <div class="modal-header" style="background:#f8fafc; padding:15px 20px; border-bottom:1px solid #e2e8f0;">
        <h3 style="margin:0; font-size:1.1rem; color:#1e293b;">Schedule Interview</h3>
        <p id="modalSub" style="margin:5px 0 0; font-size:0.85rem; color:#64748b;">Candidate Name</p>
    </div>
    
    <form id="scheduleForm" method="post" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
        {% csrf_token %}
        
        <div>
            <label style="display:block; font-size:0.9rem; font-weight:600; color:#475569; margin-bottom:5px;">Date & Time</label>
            <input type="datetime-local" name="interview_date" required
                   style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
        </div>

        <div>
            <label style="display:block; font-size:0.9rem; font-weight:600; color:#475569; margin-bottom:5px;">Meeting Link / Location</label>
            <input type="text" name="interview_link" placeholder="e.g. Google Meet Link or Office Address" required
                   style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
        </div>

        <div>
            <label style="display:block; font-size:0.9rem; font-weight:600; color:#475569; margin-bottom:5px;">Notes (Included in email)</label>
            <textarea name="message_notes" rows="3" placeholder="Additional instructions for the candidate..."
                      style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;"></textarea>
        </div>

        <div class="modal-actions" style="margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" class="btn-cancel" onclick="document.getElementById('scheduleModal').close()"
                    style="padding:8px 16px; border:1px solid #cbd5e1; background:white; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
            <button type="submit" class="btn-submit"
                    style="padding:8px 16px; border:none; background:#2563eb; color:white; border-radius:6px; cursor:pointer;">
                Send Invite
            </button>
        </div>
    </form>
</dialog> -->


<dialog id="scheduleModal" style="border:none; border-radius:12px; padding:0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 600px; max-width:95vw;">
    <div class="modal-header" style="background:#f8fafc; padding:15px 20px; border-bottom:1px solid #e2e8f0;">
        <h3 style="margin:0; font-size:1.1rem; color:#1e293b;">Schedule Interview</h3>
        <p id="modalSub" style="margin:5px 0 0; font-size:0.85rem; color:#64748b;">Candidate Name</p>
    </div>
    
    <form id="scheduleForm" method="post" style="padding: 20px; display: flex; flex-direction: column; gap: 20px;">
        {% csrf_token %}
        
        <input type="hidden" id="candidateNameHidden">
        <input type="hidden" id="jobNameHidden">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <label style="display:block; font-size:0.85rem; font-weight:600; color:#475569; margin-bottom:5px;">Date & Time</label>
                <input type="datetime-local" id="interview_date" name="interview_date" required
                       oninput="updateEmailDraft()"
                       style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
            </div>
            <div>
                <label style="display:block; font-size:0.85rem; font-weight:600; color:#475569; margin-bottom:5px;">Link / Location</label>
                <input type="text" id="interview_link" name="interview_link" placeholder="e.g. Google Meet" required
                       oninput="updateEmailDraft()"
                       style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
            </div>
        </div>

        <hr style="border:0; border-top:1px solid #e2e8f0; margin:0;">

        <div>
            <label style="display:block; font-size:0.85rem; font-weight:600; color:#475569; margin-bottom:8px;">
                <i class="bi bi-envelope"></i> Email Preview (You can edit this)
            </label>
            
            <input type="text" id="email_subject" name="email_subject" placeholder="Subject Line"
                   style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px; margin-bottom:10px; font-weight:600; color:#334155;">
            
            <textarea id="email_body" name="email_body" rows="8" 
                      style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:sans-serif; line-height:1.5; font-size:0.9rem; color:#334155;"></textarea>
        </div>

        <div class="modal-actions" style="margin-top:0px; display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" class="btn-cancel" onclick="document.getElementById('scheduleModal').close()"
                    style="padding:8px 16px; border:1px solid #cbd5e1; background:white; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
            <button type="submit" class="btn-submit"
                    style="padding:8px 16px; border:none; background:#2563eb; color:white; border-radius:6px; cursor:pointer;">
                <i class="bi bi-send-fill"></i> Send Invitation
            </button>
        </div>
    </form>
</dialog>

<script>
// Track if user has manually edited the body to stop auto-overwrite
let isManualEdit = false;

function openScheduleModal(scoreId, name, job) {
    const modal = document.getElementById('scheduleModal');
    const form = document.getElementById('scheduleForm');
    const sub = document.getElementById('modalSub');
    
    // Store data for the generator
    document.getElementById('candidateNameHidden').value = name;
    document.getElementById('jobNameHidden').value = job;
    
    // Reset inputs
    isManualEdit = false;
    document.getElementById('interview_date').value = '';
    document.getElementById('interview_link').value = '';

    if (!modal || !form) return;

    // Update Form Action & UI
    form.action = `/schedule/${scoreId}/`;
    if (sub) sub.innerText = `For ${name} (${job})`;
    
    // Trigger initial draft
    updateEmailDraft();
    
    modal.showModal();
}

function updateEmailDraft() {
    // If user manually edited the text, don't overwrite it automatically
    if (isManualEdit) return;

    const name = document.getElementById('candidateNameHidden').value;
    const job = document.getElementById('jobNameHidden').value;
    const dateVal = document.getElementById('interview_date').value;
    const link = document.getElementById('interview_link').value;

    // Format Date nicely (if present)
    let dateStr = "[Date & Time]";
    if (dateVal) {
        const d = new Date(dateVal);
        dateStr = d.toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' });
    }

    const subject = `Interview Invitation: ${job}`;
    const body = `Dear ${name},

We reviewed your application for the ${job} position and were impressed with your profile. We would like to invite you for an interview to discuss your experience further.

Details:
Date: ${dateStr}
Location/Link: ${link || "[Link]"}

Please let us know if this time works for you.

Best regards,
Hiring Team`;

    document.getElementById('email_subject').value = subject;
    document.getElementById('email_body').value = body;
}

// Mark as manual edit once user types in the textarea
document.getElementById('email_body').addEventListener('input', () => {
    isManualEdit = true;
});

// Close Modal Logic
document.addEventListener("DOMContentLoaded", () => {
    const schedModal = document.getElementById('scheduleModal');
    if (schedModal) {
        schedModal.addEventListener('click', (event) => {
            if (event.target === schedModal) {
                schedModal.close();
            }
        });
    }
});
</script>



<script>
// ----------------------------------------
// 1. GLOBAL FUNCTIONS (Accessible by onClick in HTML)
// ----------------------------------------

// A. Open Human Rate Modal
function openHumanRateModal(resumeId, name, criteriaList, existingScores) {
    const modal = document.getElementById('humanRateModal');
    const form = document.getElementById('humanRateForm');
    const container = document.getElementById('criteriaInputs');
    const sub = document.getElementById('rateModalSub');
    
    // Set Resume ID
    form.dataset.resumeId = resumeId;
    sub.innerText = `Rating: ${name}`;
    container.innerHTML = ""; 

    // Parse Data
    const criteria = typeof criteriaList === 'string' ? JSON.parse(criteriaList) : criteriaList;
    const scores = typeof existingScores === 'string' ? JSON.parse(existingScores) : (existingScores || {});

    if (!criteria || criteria.length === 0) {
        container.innerHTML = "<p class='muted'>No criteria found. Rating Overall Fit.</p>";
        criteria.push({title: "Overall Fit", score: 0});
    }

    criteria.forEach(item => {
        // Handle both simple string case and object case
        const title = item.title || item; 
        const aiScore = item.score !== undefined ? item.score : null;
        
        // Get existing human score OR default to AI score (if available) OR 50
        const currentVal = scores[title] !== undefined ? scores[title] : (aiScore || 50);

        // HTML with AI Reference Score
        const html = `
            <div style="margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-weight:600; color:#334155; font-size:0.9rem;">
                        ${title}
                        ${aiScore !== null ? `<span style="font-size:0.75em; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:4px; margin-left:8px;">AI: ${aiScore}</span>` : ''}
                    </span>
                    <span id="val-${title.replace(/\s/g, '')}" style="font-weight:bold; color:#2563eb; font-size:1rem;">
                        ${currentVal}
                    </span>
                </div>
                <input type="range" name="${title}" min="0" max="100" value="${currentVal}" 
                       oninput="document.getElementById('val-${title.replace(/\s/g, '')}').innerText = this.value"
                       style="width:100%; cursor:pointer; accent-color:#2563eb;">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94a3b8; margin-top:2px;">
                    <span>Poor (0)</span>
                    <span>Excellent (100)</span>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
    
    modal.showModal();
}

// B. Shortlist Candidate Function
// async function shortlistCandidate(resumeId, btnElement) {
//     if (!confirm("Move this candidate to Shortlisted?")) return;

//     try {
//         const originalContent = btnElement.innerHTML;
//         btnElement.innerHTML = '<div class="loading-spinner" style="width:12px; height:12px;"></div>';
//         btnElement.disabled = true;

//         const csrfToken = document.getElementById('csrf-token')?.value;

//         const response = await fetch(`/shortlist/${resumeId}/`, {
//             method: 'POST',
//             headers: {
//                 'X-CSRFToken': csrfToken,
//                 'Content-Type': 'application/json'
//             }
//         });

//         if (response.ok) {
//             const card = btnElement.closest('.score-card') || btnElement.closest('.score-row');
//             if (card) {
//                 card.style.transition = "opacity 0.5s, transform 0.5s";
//                 card.style.opacity = "0";
//                 card.style.transform = "translateX(20px)";
//                 setTimeout(() => card.remove(), 500); 
//             }
//         } else {
//             alert("Error updating status.");
//             btnElement.innerHTML = originalContent;
//             btnElement.disabled = false;
//         }
//     } catch (error) {
//         console.error('Error:', error);
//         alert("Something went wrong.");
//     }
// }


// B. Shortlist Candidate Function (Toggle Version)
async function shortlistCandidate(resumeId, btnElement) {
    // 1. Get CSRF Token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.getElementById('csrf-token')?.value;

    // 2. Optimistic UI (Optional: Add spinner or just wait)
    const icon = btnElement.querySelector("i");
    const originalIconClass = icon.className;
    
    // Add a tiny spinner to the button temporarily
    icon.className = "spinner-border spinner-border-sm"; 
    btnElement.disabled = true;

    try {
        const response = await fetch(`/shortlist/${resumeId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const data = await response.json();
            
            // 3. Update Button UI based on new state
            if (data.is_shortlisted) {
                // State: SHORTLISTED (Dark Green)
                btnElement.title = "Remove from Shortlist";
                btnElement.dataset.status = "SHORTLISTED";
                
                // Update Styles
                btnElement.style.color = "#ffffff";
                btnElement.style.background = "#059669";
                btnElement.style.borderColor = "#047857";
                
                // Update Icon
                icon.className = "bi bi-check-circle-fill";
            } else {
                // State: NEW (Light Green)
                btnElement.title = "Shortlist Candidate";
                btnElement.dataset.status = "NEW";
                
                // Update Styles
                btnElement.style.color = "#059669";
                btnElement.style.background = "#ecfdf5";
                btnElement.style.borderColor = "#a7f3d0";
                
                // Update Icon
                icon.className = "bi bi-check-circle";
            }
        } else {
            console.error("Server error");
            alert("Error updating status.");
            icon.className = originalIconClass; // Revert icon
        }
    } catch (error) {
        console.error('Error:', error);
        alert("Something went wrong.");
        icon.className = originalIconClass; // Revert icon
    } finally {
        btnElement.disabled = false;
    }
}


// C. Open Schedule Modal Function
function openScheduleModal(scoreId, name, job) {
    const modal = document.getElementById('scheduleModal');
    const form = document.getElementById('scheduleForm');
    const sub = document.getElementById('modalSub');
    
    if (!modal || !form) {
        console.error("Schedule modal or form not found in DOM.");
        return;
    }

    form.action = `/schedule/${scoreId}/`;
    if (sub) sub.innerText = `For ${name} (${job})`;
    
    modal.showModal();
}

// ----------------------------------------
// 2. DOM CONTENT LOADED EVENT
// ----------------------------------------
document.addEventListener("DOMContentLoaded", () => {
    
    // A. Human Rate Form Submit Listener
    const rateForm = document.getElementById('humanRateForm');
    const rateModal = document.getElementById('humanRateModal');
    window.onclick = function(event) {
        if (event.target === schedModal) {
            schedModal.close();
        }
        if (event.target === rateModal) { // Add this check
            rateModal.close();
        }
    }
    if(rateForm) {
        rateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const resumeId = form.dataset.resumeId;
            const inputs = form.querySelectorAll('input');
            const csrfToken = document.getElementById('csrf-token')?.value;
            
            const breakdown = {};
            inputs.forEach(input => {
                breakdown[input.name] = parseInt(input.value);
            });

            try {
                const response = await fetch(`/rate-human/${resumeId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ breakdown: breakdown })
                });

                if (response.ok) {
                    alert("Manager score saved!");
                    location.reload(); 
                } else {
                    alert("Failed to save score.");
                }
            } catch (err) {
                console.error(err);
                alert("Error saving score.");
            }
        });
    }

    // B. Safe Event Listener for Clicking Outside Modals
    const schedModal = document.getElementById('scheduleModal');
    if (schedModal) {
        schedModal.addEventListener('click', (event) => {
            if (event.target === schedModal) {
                schedModal.close();
            }
        });
    }

    // C. Setup Variables for Infinite Scroll
    const wrapper = document.getElementById("results-wrapper");
    const resultCount = document.getElementById("result-count");
    const status = document.getElementById("scroll-status");
    const csrfToken = document.getElementById("csrf-token")?.value || "";
    
    // D. Infinite Scroll Logic
    let updateCount = () => {};
    if (wrapper) {
        let loading = false;
        let loaded = Number(wrapper.dataset.loaded || 0);
        const total = Number(wrapper.dataset.total || 0);
        const viewMode = wrapper.dataset.viewMode || "tiles";
        const sort = wrapper.dataset.sort || "score_date";
        const jobId = wrapper.dataset.jobId || "";
        const currentTab = wrapper.dataset.currentTab || "inbox";
        const pageSize = Number(wrapper.dataset.pageSize || 20);
        const appendTarget = viewMode === "table" ? document.getElementById("score-table-body") : document.getElementById("score-card-grid");

        updateCount = (value) => {
            loaded = value;
            wrapper.dataset.loaded = loaded;
            const totalValue = Number(wrapper.dataset.total || total);
            if (resultCount) {
                const plural = totalValue === 1 ? "" : "s";
                resultCount.textContent = `Showing ${loaded} of ${totalValue} result${plural} (page size ${pageSize})`;
            }
        };

        const fetchNext = async () => {
            const nextPage = wrapper.dataset.nextPage;
            if (!nextPage || loading) return;
            loading = true;
            if (status) {
                status.style.display = "block";
                status.textContent = "Loading more results...";
            }
            const params = new URLSearchParams({
                page: nextPage,
                sort: sort,
                view: viewMode,
                page_size: pageSize,
                apply: "1",
                tab: currentTab,
            });
            if (jobId) params.append("job", jobId);
            
            const favInput = document.querySelector('input[name="favorites"]');
            if(favInput && favInput.checked) params.append("favorites", "1");

            try {
                const response = await fetch(`/?${params.toString()}`, {
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                });
                if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
                
                const data = await response.json();
                if (data.html && appendTarget) {
                    appendTarget.insertAdjacentHTML("beforeend", data.html);
                }
                if (data.has_next && data.next_page) {
                    wrapper.dataset.nextPage = data.next_page;
                    if (status) status.textContent = "Scroll to load more results...";
                } else {
                    wrapper.dataset.nextPage = "";
                    if (status) status.textContent = "All results loaded.";
                }
                if (data.end_index) {
                    updateCount(data.end_index);
                } else if (data.added) {
                    updateCount(Math.min(total, loaded + data.added));
                }
            } catch (error) {
                console.error(error);
                if (status) status.textContent = "Unable to load more results. Refresh page.";
            } finally {
                loading = false;
            }
        };

        const handleScroll = () => {
            if (!wrapper.dataset.nextPage || loading) return;
            const scrollPosition = window.innerHeight + window.scrollY;
            const triggerPoint = document.body.offsetHeight - 200;
            if (scrollPosition >= triggerPoint) fetchNext();
        };

        window.addEventListener("scroll", handleScroll, { passive: true });
    }

    // E. Rescore Logic
    document.addEventListener("submit", async (event) => {
        const form = event.target.closest(".rescore-form");
        if (!form) return;
        event.preventDefault();
        const submitBtn = form.querySelector("button[type=submit]");
        const originalText = submitBtn ? submitBtn.textContent : "";
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Rescoring...";
        }
        const csrfInput = form.querySelector("input[name=csrfmiddlewaretoken]");
        const formData = new FormData(form);
        try {
            const resp = await fetch(form.action, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrfInput ? csrfInput.value : "",
                },
                body: formData,
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.message || "Rescore failed");
            alert(data.message || "Rescored.");
            if(data.total_score && data.total_score < 60) {
                 window.location.reload(); 
            }
        } catch (err) {
            alert(err.message || "Rescore failed.");
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText || "Rescore";
            }
            return;
        }
        if (submitBtn) submitBtn.textContent = "Done";
    });

    // F. Toggle Flags
    document.addEventListener("change", async (event) => {
        if (!event.target.classList.contains("fav-input") && !event.target.classList.contains("fav-checkbox")) return;
        
        const checkbox = event.target;
        const resumeId = checkbox.dataset.resumeId;
        const field = "is_favorite"; 
        const isChecked = checkbox.checked;

        try {
            const formData = new FormData();
            formData.append("field", field);
            formData.append("value", isChecked ? "true" : "false");
            formData.append("csrfmiddlewaretoken", csrfToken);

            const resp = await fetch(`/resumes/${resumeId}/toggle/`, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },
                body: formData,
            });
            
            if (!resp.ok) throw new Error("Update failed");
        } catch (err) {
            console.error(err);
            alert("Unable to save favorite status.");
            checkbox.checked = !isChecked; 
        }
    });

    // G. Chat Search
    const chatInput = document.getElementById("chat-inline");
    const chatSessionInput = document.getElementById("chat-session-id");
    const filterForm = document.querySelector("#dashboard-filter-form");
    
    const applyChatResults = (data) => {
        if (!wrapper) return;
        const appendTarget = wrapper.dataset.viewMode === "table" ? document.getElementById("score-table-body") : document.getElementById("score-card-grid");
        if (!appendTarget) return;
        appendTarget.innerHTML = data.html || "";
        const count = data.count || 0;
        wrapper.dataset.loaded = count;
        wrapper.dataset.total = count;
        wrapper.dataset.nextPage = "";
        updateCount(count);
        if (status) status.textContent = "Showing chat results";
    };

    filterForm?.addEventListener("submit", async (event) => {
        const message = chatInput?.value?.trim();
        if (!message) return; 

        event.preventDefault();
        const jobSelect = document.querySelector("select[name=job]");
        const payload = {
            message,
            session_id: chatSessionInput ? chatSessionInput.value : "",
            job_id: jobSelect ? jobSelect.value : null,
            view: wrapper ? wrapper.dataset.viewMode : "tiles",
        };
        try {
            const resp = await fetch("{% url 'chat_search' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify(payload),
            });
            const data = await resp.json();
            if (chatSessionInput && data.session_id) {
                chatSessionInput.value = data.session_id;
            }
            applyChatResults(data);
        } catch (err) {
            console.error(err);
            alert("Chat search failed. Please retry.");
        }
    });
});

</script>
{% endblock %}